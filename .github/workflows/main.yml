name: Advanced ROM Builder

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CCACHE_DIR: /home/runner/.ccache
  REPO_DIR: /home/runner/repo
  TOOL_VERSIONS: '{"MKBOOTIMG":"20231020","PAYLOAD_DUMPER":"1.2.3"}'
  LIB_VERSIONS: '{"LIBLZMA":"5.2.5","ZLIB":"1.2.11","OPENSSL":"3.0.2"}'

jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure System
        run: |
          sudo timedatectl set-timezone Asia/Tehran
          echo "fs.inotify.max_user_watches=524288" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p

      - name: Setup Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.ccache
            ~/repo
          key: ${{ runner.os }}-${{ hashFiles('**/Makefile') }}-${{ github.run_number }}

      - name: Swap Management
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Install Essential Libraries
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            liblzma-dev \
            zlib1g-dev \
            libssl-dev \
            libncurses5-dev \
            libxml2-dev \
            libc6-dev \
            jq  # نصب jq برای پردازش JSON

      - name: Install Custom Tools
        run: |
          # ایجاد دایرکتوری با دسترسی کامل
          mkdir -p /home/runner/custom_tools
          echo "/home/runner/custom_tools" >> $GITHUB_PATH
          
          # تبدیل متغیرهای محیطی JSON
          TOOL_VERSIONS='${{ env.TOOL_VERSIONS }}'
          echo "Tool Versions: $TOOL_VERSIONS"

          # نصب mkbootimg با مدیریت خطا
          MKBOOTIMG_VERSION=$(echo $TOOL_VERSIONS | jq -r '.MKBOOTIMG')
          wget --tries=5 --retry-connrefused --timeout=30 \
            "https://github.com/chenxiaolong/mkbootimg/releases/download/$MKBOOTIMG_VERSION/mkbootimg" \
            -O /home/runner/custom_tools/mkbootimg
          chmod +x /home/runner/custom_tools/mkbootimg

          # نصب payload-dumper-go با مدیریت خطا
          PAYLOAD_VERSION=$(echo $TOOL_VERSIONS | jq -r '.PAYLOAD_DUMPER')
          wget --tries=5 --retry-connrefused --timeout=30 \
            "https://github.com/ssut/payload-dumper-go/releases/download/v$PAYLOAD_VERSION/payload-dumper-go_linux_amd64" \
            -O /home/runner/custom_tools/payload-dumper-go
          chmod +x /home/runner/custom_tools/payload-dumper-go

          # تأیید نصب
          echo "Installed tools:"
          ls -lh /home/runner/custom_tools

  build:
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 360

    steps:
      - name: Initialize Environment
        run: |
          ccache -M 50G
          ccache -s
          /home/runner/custom_tools/mkbootimg --version
          /home/runner/custom_tools/payload-dumper-go --version

      - name: Download Source Code
        run: |
          mkdir -p android_source
          cd android_source
          repo init -u https://github.com/PixelOS-AOSP/platform_manifest.git -b pixel-14.0
          repo sync -c -q -j$(nproc) --force-sync --no-clone-bundle

      - name: Build Preparation
        run: |
          cd android_source
          source build/envsetup.sh
          lunch aosp_chopin-userdebug

      - name: Compile ROM
        run: |
          cd android_source
          make -j$(nproc) 2>&1 | tee build.log
          mkdir -p artifacts
          cp $OUT/*.img artifacts/

      - name: Post-build Actions
        run: |
          ccache -s
          sudo swapoff -a
          sudo rm -f /swapfile
          df -h
          free -h

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: rom-artifacts
          path: |
            android_source/build.log
            android_source/artifacts/*.img
          retention-days: 7

      - name: Send Notification
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = job.status
            const message = status === 'success' 
              ? '✅ ساخت ROM با موفقیت انجام شد!' 
              : '❌ خطا در فرآیند ساخت! کد خطا: ' + context.runId
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })
