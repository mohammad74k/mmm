name: Build ROM & Custom Recovery

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # زمان لازم برای مرحله آماده‌سازی

    steps:
      # مرحله 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # مرحله 2: تنظیم فضای Swap برای بهبود عملکرد
      - name: تنظیم فضای Swap برای بهبود عملکرد
        run: |
          set -e
          
          # خاموش کردن سوایپ قبلی
          sudo swapoff -a || true
          sudo rm -f /swapfile || true
          
          # بررسی اینکه سوایپ قبلاً فعال است یا خیر
          if swapon -s | grep -q '/swapfile'; then
            echo "✅ سوایپ قبلاً فعال است."
          else
            echo "❌ سوایپ فعال نیست. در حال ایجاد سوایپ جدید..."
            
            # بررسی فضای دیسک
            echo "بررسی فضای دیسک:"
            df -h
            
            # ایجاد سوایپ جدید
            sudo fallocate -l 8G /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=8192
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            free -h
            echo "✅ سوایپ جدید با موفقیت ایجاد و فعال شد."
          fi

      # مراحل دیگر همانند قبل...

  build:
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 480  # افزایش زمان timeout برای ساخت‌های طولانی‌تر

    steps:
      # مرحله 9: دانلود و استخراج MIUI Fastboot
      - name: دانلود و استخراج MIUI Fastboot
        run: |
          set -e
          mkdir -p miui_rom
          cd miui_rom
          wget -O miui_fastboot_rom.tgz "https://bkt-sgp-miui-ota-update-alisgp.oss-ap-southeast-1.aliyuncs.com/V14.0.6.0.TKPMIXM/chopin_global_images_V14.0.6.0.TKPMIXM_20240528.0000.00_13.0_global_253b98dc56.tgz" || \
              (echo "❌ دانلود MIUI Fastboot ناموفق بود" && exit 1)
          tar -xvf miui_fastboot_rom.tgz --strip-components=1 || \
              (echo "❌ استخراج MIUI Fastboot ناموفق بود" && exit 1)
          echo "✅ دانلود و استخراج MIUI Fastboot موفقیت‌آمیز بود"

      # مرحله 10: استخراج کرنل، وندر و فریمور
      - name: استخراج کرنل، وندر و فریمور
        run: |
          set -e
          mkdir -p extracted/
          cd miui_rom
          
          # تبدیل super.img به فایل raw
          simg2img super.img super.raw.img || \
              (echo "❌ تبدیل super.img به raw ناموفق بود" && exit 1)
          
          # استخراج محتوای فایل raw.img
          mkdir super_extracted && cd super_extracted
          7z x ../super.raw.img -o. || \
              (echo "❌ استخراج super.raw.img ناموفق بود" && exit 1)

          # استخراج کرنل، وندر و فریمور
          mkdir -p ../../vendor && mv system/vendor ../../vendor/
          mkdir -p ../../firmware && mv system/firmware ../../firmware/
          mkdir -p ../../kernel && mv boot.img ../../kernel/
          
          # استخراج device tree
          mkdir -p ../../device_tree
          cp -r system/etc/selinux ../../device_tree/ || \
              (echo "❌ استخراج device tree ناموفق بود" && exit 1)
          
          echo "✅ استخراج کرنل، وندر، فریمور و device tree انجام شد"

      # مرحله 11: دانلود کدهای Android 14 (Pixel OS)
      - name: دانلود کدهای Android 14 (Pixel OS)
        run: |
          set -e
          mkdir -p android_source
          cd android_source
          repo init -u https://github.com/PixelOS-AOSP/platform_manifest.git -b pixel-14.0
          repo sync -j$(nproc) || (echo "❌ دانلود کدهای Android با مشکل مواجه شد" && exit 1)
          echo "✅ دانلود کدهای Android 14 (Pixel OS) موفقیت‌آمیز بود"

      # مرحله 12: وارد شدن به محیط ساخت
      - name: وارد شدن به محیط ساخت
        run: |
          set -e
          source android_source/build/envsetup.sh
          lunch aosp_chopin-userdebug || (echo "❌ تنظیم lunch ناموفق بود" && exit 1)
          echo "✅ lunch با موفقیت تنظیم شد"

      # مرحله 13: ساخت کاستوم ریکاوری
      - name: ساخت کاستوم ریکاوری
        run: |
          set -e
          # ساخت ریکاوری
          make recoveryimage -j$(nproc) || (echo "❌ ساخت کاستوم ریکاوری با مشکل مواجه شد" && exit 1)
          echo "✅ ساخت کاستوم ریکاوری با موفقیت انجام شد."

      # مرحله 14: ساخت ROM
      - name: ساخت ROM
        run: |
          set -e
          make -j$(nproc) || (echo "❌ ساخت ROM با مشکل مواجه شد" && exit 1)
          echo "✅ ساخت ROM با موفقیت انجام شد."

      # مرحله 15: انتشار و ذخیره رام ساخته شده
      - name: انتشار رام ساخته شده
        run: |
          set -e
          cp out/target/product/chopin/*.zip /home/username/roms/
          cp out/target/product/chopin/recovery.img /home/username/roms/
          echo "✅ رام ساخته شده و recovery.img در مسیر مشخص شده قرار دارد."
