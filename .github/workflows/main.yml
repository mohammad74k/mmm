name: Advanced ROM Builder

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CCACHE_DIR: /home/runner/.ccache
  REPO_DIR: /home/runner/repo

jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure System
        run: |
          sudo timedatectl set-timezone Asia/Tehran
          echo "fs.inotify.max_user_watches=524288" | sudo tee -a /etc/sysctl.conf
          sudo sysctl -p

      - name: Setup Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.ccache
            ~/repo
          key: ${{ runner.os }}-${{ hashFiles('**/Makefile') }}-${{ github.run_number }}

      - name: Swap Management
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Install Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            git \
            make \
            python3 \
            liblzma-dev \
            zlib1g-dev \
            wget \
            tar

      - name: Install mkbootimg from Source
        run: |
          git clone https://github.com/chenxiaolong/mkbootimg.git
          cd mkbootimg
          make
          sudo mv mkbootimg/mkbootimg /usr/local/bin/
          cd ..
          mkbootimg --version

      - name: Install payload-dumper-go
        run: |
          PAYLOAD_VERSION="1.2.3"
          wget https://github.com/ssut/payload-dumper-go/releases/download/v${PAYLOAD_VERSION}/payload-dumper-go_${PAYLOAD_VERSION}_linux_amd64.tar.gz
          tar -xzf payload-dumper-go_${PAYLOAD_VERSION}_linux_amd64.tar.gz
          chmod +x payload-dumper-go
          sudo mv payload-dumper-go /usr/local/bin/
          payload-dumper-go --version

  build:
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 360

    steps:
      - name: Initialize Environment
        run: |
          ccache -M 50G
          ccache -s

      - name: Download Android Source
        run: |
          mkdir -p android_source
          cd android_source
          repo init -u https://github.com/PixelOS-AOSP/platform_manifest.git -b pixel-14.0
          repo sync -c -q -j$(nproc) --force-sync --no-clone-bundle

      - name: Setup Build Environment
        run: |
          cd android_source
          source build/envsetup.sh
          lunch aosp_chopin-userdebug

      - name: Build ROM
        run: |
          cd android_source
          make -j$(nproc) 2>&1 | tee build.log
          mkdir -p artifacts
          cp $OUT/*.img artifacts/

      - name: Post-build Cleanup
        run: |
          ccache -s
          sudo swapoff -a
          sudo rm -f /swapfile
          df -h
          free -h

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: rom-artifacts
          path: |
            android_source/build.log
            android_source/artifacts/*.img
          retention-days: 7

      - name: Notify Status
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = job.status
            const message = status === 'success' 
              ? '✅ ساخت ROM با موفقیت انجام شد!\nزمان اجرا: ${{ job.steps.*.conclusion }}' 
              : '❌ خطا در فرآیند ساخت!\nکد خطا: ${{ github.run_id }}'
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })
