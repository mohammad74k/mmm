name: Build ROM

on: push: branches: - main pull_request: branches: - main workflow_dispatch:

jobs: prepare: runs-on: ubuntu-latest timeout-minutes: 240

steps:
  - name: Checkout repository
    uses: actions/checkout@v3

  - name: ØªÙ†Ø¸ÛŒÙ… ÙØ¶Ø§ÛŒ Swap
    run: |
      set -e
      sudo swapoff -a || true
      sudo rm -f /swapfile || true
      if ! swapon -s | grep -q '/swapfile'; then
        sudo fallocate -l 16G /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=16384
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h
      fi

  - name: Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø®Ø²Ù† Universe
    run: |
      sudo add-apt-repository -y universe
      sudo apt update

  - name: Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ùˆ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ APT
    run: |
      sudo apt clean
      sudo rm -rf /var/lib/apt/lists/*
      for i in {1..3}; do sudo apt update && break || sleep 15; done
      sudo apt upgrade -y || true

  - name: Ø­Ù„ Ù…Ø´Ú©Ù„Ø§Øª dpkg
    run: |
      sudo dpkg --configure -a || true
      sudo apt install -f -y || true

  - name: Ù†ØµØ¨ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
    run: |
      set -e
      install_packages() {
        sudo DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends \
            openjdk-17-jdk repo git-core gnupg flex bison gperf build-essential \
            zlib1g-dev libc6-dev libncurses5-dev x11proto-core-dev libx11-dev \
            libgl1-mesa-dev libxml2-utils xsltproc unzip python3 python3-pip \
            android-sdk-libsparse-utils wget ccache lz4 liblz4-tool liblzma-dev \
            f2fs-tools squashfs-tools golang-go
      }
      for i in {1..3}; do install_packages && break || sleep 15; done

  - name: Ù†ØµØ¨ mkbootimg
    run: |
      if ! sudo apt install -y android-tools-mkbootimg; then
        curl -LO https://github.com/chenxiaolong/android_device_xiaomi_msm8916-common/raw/master/tools/mkbootimg/mkbootimg
        chmod +x mkbootimg
        sudo mv mkbootimg /usr/local/bin/
      fi

build: runs-on: ubuntu-latest needs: prepare timeout-minutes: 720

steps:
  - name: Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ ROM
    run: |
      mkdir -p custom_rom
      cd custom_rom
      ZIP_FILE="evolution_chopin-ota.zip"
      ZIP_URL="https://mirrors.ilolicon.com/ROM/evolution_chopin-ota.zip"
      
      if [ ! -f "$ZIP_FILE" ] || ! unzip -tq "$ZIP_FILE"; then
        wget --retry-connrefused --waitretry=30 --tries=5 -O "$ZIP_FILE" "$ZIP_URL"
      fi
      unzip -q "$ZIP_FILE"

  - name: Ø§Ø³ØªØ®Ø±Ø§Ø¬ payload.bin
    run: |
      cd custom_rom
      payload_file=$(find . -name "payload.bin" -print -quit)
      
      if ! command -v payload-dumper-go &>/dev/null; then
        go install github.com/ssut/payload-dumper-go@latest
      fi

      mkdir -p extracted_payload
      if [ -f "$payload_file" ]; then
        payload-dumper-go -o extracted_payload "$payload_file"
      else
        echo "âŒ ÙØ§ÛŒÙ„ payload.bin ÛŒØ§ÙØª Ù†Ø´Ø¯!"
        exit 1
      fi
      echo "ğŸ“‚ Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬â€ŒØ´Ø¯Ù‡ Ø§Ø² payload.bin:"
      find extracted_payload -type f -ls

  - name: Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ vendor.img
    run: |
      cd custom_rom
      echo "ğŸ“‚ Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± extracted_payload:"
      ls -lh extracted_payload
      
      vendor_img_path=$(find extracted_payload -name "vendor.img" -print -quit)
      
      if [ -f "$vendor_img_path" ]; then
        mkdir -p ../android_source/device/xiaomi/chopin/vendor
        cp "$vendor_img_path" ../android_source/device/xiaomi/chopin/vendor/
        echo "âœ… vendor.img Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯."
      else
        echo "âŒ ÙØ§ÛŒÙ„ vendor.img ÛŒØ§ÙØª Ù†Ø´Ø¯!"
        find extracted_payload -type f -ls
        exit 1
      fi

  - name: Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø³ÙˆØ±Ø³
    run: |
      cd android_source
      repo init -u https://github.com/PixelOS-AOSP/platform_manifest.git -b pixel-14.0
      repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags

  - name: Ú©Ø§Ù…Ù¾Ø§ÛŒÙ„ Ø±ÛŒÚ©Ø§ÙˆØ±ÛŒ
    run: |
      cd android_source
      source build/envsetup.sh
      lunch aosp_chopin-userdebug
      make -j$(nproc) recoveryimage

  - name: Ú©Ø§Ù…Ù¾Ø§ÛŒÙ„ Ú©Ø§Ù…Ù„
    run: |
      cd android_source
      make -j$(nproc)

  - name: Ø¨Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù†ØªØ§ÛŒØ¬
    run: |
      mkdir -p output
      cp android_source/out/target/product/chopin/*.img output/
      echo "âœ… Ø³Ø§Ø®Øª ROM Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!"

