name: Test Repo Init

on:
  workflow_dispatch:

jobs:
  test-repo-init:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: تنظیم فضای Swap
        run: |
          set -e
          sudo swapoff -a || true
          sudo rm -f /swapfile || true
          if ! swapon -s | grep -q '/swapfile'; then
            sudo fallocate -l 8G /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=8192
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            free -h
          fi

      - name: نصب ابزارهای اصلی
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
              openjdk-17-jdk repo git-core gnupg flex bison gperf build-essential \
              zlib1g-dev libc6-dev libncurses5-dev x11proto-core-dev libx11-dev \
              libgl1-mesa-dev libxml2-utils xsltproc unzip python3 python3-pip \
              android-sdk-libsparse-utils wget ccache lz4 golang curl

      - name: نصب و استفاده از ابزار repo
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH="$HOME/bin:$PATH"

          # تنظیم هویت Git (ضروری برای repo sync)
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # ایجاد دایرکتوری android_source
          mkdir -p android_source
          cd android_source

          # اجرای repo init
          repo init -u https://github.com/PixelOS-AOSP/manifest.git -b fourteen --git-lfs

          # همگام‌سازی مخزن
          repo sync -q -j$(nproc) --no-clone-bundle --force-sync

      - name: بررسی نهایی
        run: |
          cd android_source
          if [ -d .repo ]; then
            echo "✅ repo init و repo sync با موفقیت انجام شد!"
          else
            echo "❌ خطا در اجرای repo init یا repo sync!"
            exit 1
          fi
